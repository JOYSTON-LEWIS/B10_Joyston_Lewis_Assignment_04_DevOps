name: Deploy MERN App to EC2

on:
  push:
    branches:
      - Backend
      - Frontend

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Add SSH Key
        run: |
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > private_key.pem
          chmod 600 private_key.pem

      - name: SSH and deploy on EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i private_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_PRIVATE_IP }} << 'EOF'
            set -e

            echo "ðŸ”§ Installing necessary packages..."
            sudo apt update -y
            sudo apt install -y git nginx

            if ! command -v node || [[ "$(node -v)" != v20* ]]; then
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt install -y nodejs
            fi

            command -v docker || curl -fsSL https://get.docker.com | sh

            echo "ðŸ“ Creating folders..."
            mkdir -p ~/Backend ~/Frontend

            ##########################################
            ## Backend Deployment
            ##########################################
            echo "ðŸ“¦ Cloning backend repo..."
            cd ~/Backend
            rm -rf B10_Joyston_Lewis_Assignment_04_DevOps
            git clone https://github.com/JOYSTON-LEWIS/B10_Joyston_Lewis_Assignment_04_DevOps
            cd B10_Joyston_Lewis_Assignment_04_DevOps
            git checkout Backend

            echo "ðŸ›‘ Stopping old backend container..."
            docker stop ${{ secrets.EC2_DOCKER_BACKEND_CONTAINER_NAME }} || true
            docker rm ${{ secrets.EC2_DOCKER_BACKEND_CONTAINER_NAME }} || true

            echo "ðŸ“ Creating backend Dockerfile..."
            cat > Dockerfile <<EOL
            FROM node:20-alpine
            WORKDIR /app
            COPY package*.json ./
            RUN npm install --omit=dev
            COPY . .
            ENV PORT=3001
            ENV MONGO_URI=${{ secrets.MONGO_DB_CLUSTER_SECRET_KEY }}
            EXPOSE 3001
            CMD ["node", "index.js"]
            EOL

            echo "ðŸ³ Building and running backend container..."
            docker build -t backend-app .
            docker run -d --name ${{ secrets.EC2_DOCKER_BACKEND_CONTAINER_NAME }} -p 3001:3001 backend-app

            ##########################################
            ## Frontend Deployment
            ##########################################
            echo "ðŸ“¦ Cloning frontend repo..."
            cd ~/Frontend
            rm -rf B10_Joyston_Lewis_Assignment_04_DevOps
            git clone https://github.com/JOYSTON-LEWIS/B10_Joyston_Lewis_Assignment_04_DevOps
            cd B10_Joyston_Lewis_Assignment_04_DevOps
            git checkout Frontend

            echo "ðŸ›‘ Stopping old frontend container..."
            docker stop ${{ secrets.EC2_DOCKER_FRONTEND_CONTAINER_NAME }} || true
            docker rm ${{ secrets.EC2_DOCKER_FRONTEND_CONTAINER_NAME }} || true

            echo "ðŸŒ Creating .env file for frontend..."
            echo "VITE_API_BASE_URL=http://${{ secrets.EC2_PRIVATE_IP }}:3001" > .env

            echo "ðŸ“ Creating frontend Dockerfile..."
            cat > Dockerfile <<EOL
            FROM node:20
            WORKDIR /app
            COPY . .
            RUN npm install
            EXPOSE 3000
            CMD ["npm", "run", "dev", "--", "--port", "3000", "--host"]
            EOL

            echo "ðŸ³ Building and running frontend container..."
            docker build -t frontend-app .
            docker run -d --name ${{ secrets.EC2_DOCKER_FRONTEND_CONTAINER_NAME }} -p 3000:3000 frontend-app

            echo "âœ… Deployment finished successfully!"
          EOF
