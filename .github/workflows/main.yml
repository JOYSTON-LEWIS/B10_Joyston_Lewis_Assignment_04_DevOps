name: Deploy MERN App to EC2

on:
  push:
    branches:
      - Backend
      - Frontend

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Add SSH Key
        run: |
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > private_key.pem
          chmod 600 private_key.pem

      - name: SSH and deploy on EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i private_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_PRIVATE_IP }} << 'EOF'
            set -e

            echo "üîß Installing necessary packages..."
            sudo apt update -y
            sudo apt install -y git nginx

            if ! command -v node || [[ "$(node -v)" != v20* ]]; then
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt install -y nodejs
            fi

            command -v docker || curl -fsSL https://get.docker.com | sh

            echo "üßπ Cleaning old directories and Docker containers..."
            rm -rf ~/Backend ~/Frontend
            docker stop ${{ secrets.EC2_DOCKER_BACKEND_CONTAINER_NAME }} || true
            docker rm ${{ secrets.EC2_DOCKER_BACKEND_CONTAINER_NAME }} || true
            docker stop ${{ secrets.EC2_DOCKER_FRONTEND_CONTAINER_NAME }} || true
            docker rm ${{ secrets.EC2_DOCKER_FRONTEND_CONTAINER_NAME }} || true
            docker system prune -f

            ##########################################
            ## Backend Deployment
            ##########################################
            echo "üì¶ Cloning backend repo..."
            mkdir -p ~/Backend
            cd ~/Backend
            git clone https://github.com/JOYSTON-LEWIS/B10_Joyston_Lewis_Assignment_04_DevOps
            cd B10_Joyston_Lewis_Assignment_04_DevOps
            git checkout Backend

            echo "üìù Creating backend Dockerfile..."
            cat <<EOL > Dockerfile
            FROM node:20-alpine
            WORKDIR /app
            COPY package*.json ./
            RUN npm install --omit=dev
            COPY . .
            ENV PORT=3001
            ENV MONGO_URI=${{ secrets.MONGO_DB_CLUSTER_SECRET_KEY }}
            EXPOSE 3001
            CMD ["node", "index.js"]
            EOL

            echo "üê≥ Building and running backend container..."
            docker build -t backend-app .
            docker run -d --name ${{ secrets.EC2_DOCKER_BACKEND_CONTAINER_NAME }} -p 3001:3001 backend-app

            ##########################################
            ## Frontend Deployment
            ##########################################
            echo "üì¶ Cloning frontend repo..."
            mkdir -p ~/Frontend
            cd ~/Frontend
            git clone https://github.com/JOYSTON-LEWIS/B10_Joyston_Lewis_Assignment_04_DevOps
            cd B10_Joyston_Lewis_Assignment_04_DevOps
            git checkout Frontend

            echo "üåç Creating .env file for frontend..."
            echo "VITE_API_BASE_URL=http://${{ secrets.EC2_PRIVATE_IP }}:3001" > .env

            echo "üìù Creating frontend Dockerfile..."
            cat <<EOL > Dockerfile
            FROM node:20
            WORKDIR /app
            COPY . .
            RUN npm install
            RUN npm run build
            RUN npm install -g serve
            EXPOSE 3000
            CMD ["serve", "-s", "dist", "-l", "3000"]
            EOL

            echo "üê≥ Building and running frontend container..."
            docker build -t frontend-app .
            docker run -d --name ${{ secrets.EC2_DOCKER_FRONTEND_CONTAINER_NAME }} -p 3003:3000 frontend-app

            echo "‚úÖ Deployment finished successfully!"
          EOF
